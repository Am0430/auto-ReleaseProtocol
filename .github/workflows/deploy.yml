name: 部署用户协议到S3

on:
  push:
    paths:
      - 'source/user_agreement.html'  # 只有当源文件更新时触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 生成固定文件名
        id: generate_filename
        run: |
          echo "html_filename=user_agreement.html" >> $GITHUB_ENV

      - name: 配置AWS凭证
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: cn-northwest-1  # 替换为你的S3区域

      - name: 上传到S3指定路径
        run: |
          aws s3 cp source/user_agreement.html \
            s3://test-autoreleaseprotocol/mp/${{ env.html_filename }} \
            --acl public-read

      - name: 刷新CloudFront缓存
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/mp/${{ env.html_filename }}"